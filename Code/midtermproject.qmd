---
title: "Mid-term project instructions"
author: "FULL NAME STUDENT 1 & FULL NAME STUDENT 2"
format:
  html:
    code-fold: false
    embed-resources: true
    toc: true
    number-sections: true
    theme: cerulean
---

# Mid-term project GitHub repository URL:

Paste here the URL of the GitHub project (after going through the instruction steps)

# Instructions

This file contains both the **instructions** for the mid-term project and placeholders for your code. You are required to use this file to produce code, output, and answers to the questions below.

Besides simply creating output, make sure to interpret the output. You will need to create tables and/or plots to arrive at the answers, and then comment on what you found below it.

To get you setup, you will need to:

-   Student #1: create a repository on your GitHub account. You can call this repository "2024dsa_midproject_groupX", **where X is the number of your group**. Make it public, add a README, add a .gitignore for R.\
-   Student #1: follow the steps we did in class to start a new RStudio project with version control.\
-   Student #1: in your computer, create the sub-folders code, data, output, and move your data set into the `data` folder. Also, student 1 moves this current script into the `code` folder. Do a git stage, commit, push.\
-   Student #1: on GitHub, go the repository settings and invite your partner to be a collaborator in the repository. That will give them push permission.\
-   Now, both students should clone this repository on their computers like we did in class. Make sure this step works well and that you can pull and push from GitHub.\
-   Student 2, after cloning, does a git pull to get all these updates on their computer.\
-   Student 1 and 2 work together to update the README file. README files should explain what the repository is about, the goals of that project, who is working in it, and any other important details you may find.

# Introduction

Gross Primary Production(GPP) and soil respiration make the highest carbon fluxes from the terrestrial ecosystem to the atmosphere (Bond-Lamberty and Thomson, 2010). Due to the magnitude of the CO2 flux from soils to atmosphere and the huge reserve of potential C in soils, any increases in soil respiration due to man-made or environmental changes may increase atmospheric CO2 levels and exacerbate global warming. Soil respiration consists mainly of respiration from roots, mycorrhizal fungi and microbes. Microbial respiration of soil C is the highest of the three (Wang and Fang, 2009). 

Human activities have been significantly modifying biogeochemical cycles in many ways. Management practices like tillage and fertilization are one of the key factors contributing to increasing CO2 efflux from soils. Nitrogen is the most important component for plant growth, is often limiting in ecosystems, and could affect soil respiration by altering microbial biomass, their activity and root growth (Ding et al.,2010). Studies have found a sharp increase in CO2 efflux following tillage, mainly due to broken soil clods and aggregates which act as "gas tankers" (Fielder et al., 2015; Morell et al., 2010). Although, sharp increases of CO2 efflux are seen following tillage, the extent of the increase depends on cultivation type, Soil Organic Carbon (SOC), soil texture and structure. 

Soil temperature and soil water content are considered the main environmental controls of soil respiration, as these can affect both microbial and root growth. The indirect effects of these factors, nutrient availability and plant productivity can also affect CO2 efflux from soils. Rainfall events can result in changes in both soil temperature and water content, and has been part of numerous studies (Shi et al., 2011; Muhr et al., 2010; Morell et al., 2010). But there are very few studies, where the combined effects of management practices, soil temperature and soil moisture have been studied. 

In this experiment, we try to see the effects of common land management practices on soil respiration across different days following precipitation. 
# Hypothesis and objectives

Describe here your hypothesis, followed by your objectives. Make sure your hypothesis are testable and bold, and objectives are clear.

We hypothesize that, soil respiration increases with fertilization and tillage. Additionally, we believe that plots under these treatments will have a higher respiration following precipation as compared to the control plots. 

The objectives of this study are (a) to assess the effects of treatments fertilization, tillage or their combined effects on soil CO2 flux over six different days, (b) to assess the effects of precipitation on soil CO2 flux. 

# Material and Methods

Describe here your overall material and methods as it pertains to the analysis you will conduct, including study description, site/setup description, what equipment was used, etc. just like you would in a paper. Make sure to clearly explain what was measured and how.

## Site description

The study was conducted at the Whitehall forest in the Piedmont regions Clarke and Ocoonee county in Athens, Georgia, USA. The area has a humid subtropical climate with a mean annual precipitation of 1267.3 mm, and average January and July temperatures of 6.3 degree C and 26.3 degree C respectively. Average elevation is approximately 200m above mean sea level. 

## In-situ field measurements
The gas samples were taken in late January and early February following two precipitation events from 25 treatment plots. Each plot is fitted with Polyvinyl chloride collars at a depth of about 5cm which are used to collect gas samples. We used a Licor LI-870 gas analyzer (LI-COR Inc., Lincoln, NE, USA) to measure the CO2 flux. The device is also equipped with a probe that simultaneously measures soil moisture, soil temperature and Electrical Conductivity. The measurements were taken on six different days to see the effects of rain on soil respiration. 
The study area experienced rainfall on 28th of January 2024, and we started our soil respiration measurements from the 29th of January 2024 on days 1, 2, 3, 8,9 and 10. The repeated measure in this experiment "days after rain" are these measurements that were taken between the 29th of January 2024 and 10th of February 2024. It is worth mentioning that, there was a slight precipitation on day 7, but we did not consider this rain event as significantly affecting the experiment. 

## Study design

Clearly describe your study design here, including treatment design (which factors and levels, the hierarchy among them, etc.), and your experimental design (number of reps/blocks, how was randomization performed, etc.), as we talked about in class.  

The study consists of a set of five completely randomized blocks (within-site spatial replicates), each with five, 5x5m plots receiving either long-term nutrient addition, a physical disturbance, nutrient addition combined with disturbance, short-term nutrient addition or no treatments. The treatments were done just once at the beginning of summer every year (mid June). The randomization of the study site was carried out using a R code given on the project website (https://nutnet.org/sites/default/files/2019-07/create-site-maps-dragnet-03-July-2019.R).


## Statistical analysis

Describe here your statistical analysis, including what type of ANOVA model you ran (based on the design above), what was your response variable, what were your explanatory variables and how were the explanatory variables treated (random or fixed). Provide your alpha level. Explain which function from which package you used to analyze this data. Explain how you checked linear model assumptions and whether or not they were met. Overall, make sure you explain in sufficient detail that, if given your data, a knowledgeable person would be able to reproduce your analysis exactly.  
  
Soil respiration for different treatments were analyzed using a repeated measured mixed-effect ANOVA. Model explanatory variables included treatment (as categorical variable), days after rain (repeated measure) and their interaction as fixed effects. Plot which was nested inside blocks was modeled as the random effect. Different error correlation structures like ARMA(1), exponential, Gaussian at the plot level over all DARs, and the one with the lowest Akaike Information Criterion (AIC) was selected for further analysis. The repeated measures were of unequal time intervals, and hence the choice of correlation structures were limited. Soil moisture and temperature were also measured, since these two factors are known to have an effect on how microbes respire carbon dioxide. The two factors were considered as covariates, and hence accordingly an ANCOVA was also conducted. The assumptions of ANCOVA are as follows - 
1. Linear relationships - the effect of the categorical variable on the outcome varies linearly with the outcome.  
2. Homogeneity of slopes - The relationship between the dependent and independent variable should be consistent across all the treatment levels. Slopes of regression lines (representing the effect of covariates) should be parallel for each group.  
3. Uncorrelated covariates - The covariates must not be correlated to the error term.  
  
We ran the ANCOVA model, and checked for one of the assumptions, which were not satisfied. Hence, we went ahead with the mixed-effects ANOVA. We used an alpha level of 0.05. We used the linear mixed effect mdoel (lme) from the package nlme (Pinheiro and Bates, 2000). The linearity assumptions were checked using the QQ-plot, and a point graph to check for normality, outliers and homoscedascity. **The assumption of outliers was not met, since we found two residuals that were off the limit of 3 standard deviations. But, the raw data points were checked and it did not seem out of place, and hence we decided to not remove them from our analysis.** Apart from this, all assumptions were satisfied without any problems. 

# Results

Here is where the coding is going to happen, and it will be completely up to you. Include under this section as many sub-sections (using ##) and as many chunks needed to create the analytical workflow for your analysis, starting at loading packages and data, wrangling, EDA, modeling, assumptions checking, ANOVA table, means, pairwise comparisons, and final publication-quality plot.

Make sure to run a model that reflects your study design. Even if your study design does not include one of the designs covered in class, you are still expected to run the most appropriate model. If you need help for references, let me know.

Before each chunk, describe the steps being performed in that chunk. For example, "Here I will load the data".

If a chunk produces output, like printing a data frame, statistical summary, a plot, ANOVA table, etc., make sure to write text interpreting what you see and how you can/will use that information to move forward to the next steps in the workflow.

## Running Code

In this chunk, I will load all the packages that will be used in the process of the analysis.

```{r - Package}
#|message: False
#|warning: False
library(tidyverse)
library(janitor)
library(stringr)
library(ggpubr)
library(broom)
library(rstatix)
library(lme4)
library(nlme)
library(emmeans)
library(multcomp)
```

Here, I will load data

```{r - data }
#| echo: false
data <- read.csv("../Data/soilresp_midterm.csv")
data
summary(data)
```

In this chunk, I will manipulate and prepare the data for further analysis, including cleaning column header name, converting variables to appropriate data types and reshaping the data into a more suitable format for analyis.

```{r - data wrangling}
data_w <- data[-26,] %>% 
  clean_names() %>% 
  mutate(treatment = factor(treatment)) %>% 
  
  mutate(
    rep = case_when
    (plot == c(1:5) ~ "1",
    plot == c(6:10) ~ "2",
      plot == c(11:15) ~ "3",
      plot == c(16:20) ~ "4", 
      plot == c(21:25) ~ "5"
     )
  ) %>% 
  mutate(rep = factor(rep)) %>% 
  pivot_longer(cols =r1_01_29_24:r6_02_07_24,
               values_to = "respiration",
               names_to = "x1")   %>%
   mutate(x1 = gsub("resp", "", x1)) %>% 
 mutate(date1 = str_extract(x1, "\\d{2}_\\d{2}_\\d{2}")
  ) %>% 
  mutate(date = as.Date(date1, "%m_%d_%y")) %>% 
  mutate(dar = case_when(
    date == "2024-01-29" ~ "01",
    date == "2024-01-30" ~ "02", 
    date == "2024-01-31" ~ "03",
    date == "2024-02-05" ~ "08", 
    date == "2024-02-06" ~ "09",
    date == "2024-02-07" ~ "10"
  )) %>% 
  mutate(drying_cycle = case_when(
    date == "2024-01-29" ~ "1",
    date == "2024-01-30" ~ "1", 
    date == "2024-01-31" ~ "1",
    date == "2024-02-05" ~ "2", 
    date == "2024-02-06" ~ "2",
    date == "2024-02-07" ~ "2")
  ) %>% 
  mutate(fdar = factor(dar)) %>%
  mutate(dar = as.numeric(dar)) %>% 
  mutate(drying_cycle = factor(drying_cycle)) %>% 
  dplyr::select(c(-x1,-date1)) %>%
  mutate(plot=factor(plot))

summary(data_w)
```

In think chunk, I will group dataframe by the varibales (treatment and days after rain).

```{r}
data_w %>%
  group_by(treatment, fdar) %>%
  tally
```

```{r}
data_w %>%
  distinct(treatment, fdar, rep, plot)
```

Here, I will inspect the distribution of respiration across different level of days after rain (dar), segmented by treatment, which can provide insights into potential relationships and patterns in the data.

```{r EDA}
data_w %>% 
  ggplot(aes(fdar,respiration))+
  geom_boxplot()+
 facet_wrap(~treatment)
  
```

One of the assumptioins of the ancova model is that the dependent variable must be linearly related to the covariates.

Here, I will reshape data and visualize the data to observe the linearity of the covariates.

```{r}
data_w %>% 
   pivot_longer(cols = starts_with("sw"),
               values_to = "watercontent", 
               names_to = "x2"
               ) %>% 
  mutate(x2 = gsub("water", "", x2)) %>% 
  pivot_longer(cols = st1:st6,
               values_to = "soiltemp",
               names_to = "x3") %>% 
  mutate(x3 = gsub("temp", "", x3)) %>% 
  ggscatter(x= "watercontent", y ="respiration",
            color = "treatment", add = "reg.line")+
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~"), color = treatment)
    )
```

he linearity assumption seems to be not satisfied, and thus we move ahead with just the anova analysis.

Here, I will setup the environment for model fitting and fit the default linear mixed-effects model.

```{r - default model}
options(contrasts = c("contr.sum", "contr.poly"))

mix_mod <- lme(respiration ~ treatment*fdar,
                random = ~ 1 |rep/plot,
                data = data_w)
mix_mod
```

In this chunk, I will further insights into the fitted linear mixed-effects model, including assessing the significance of fixed effects through ANOVA and examining the autocorrelation structure of the residuals.

```{r}
Anova(mix_mod,type = 3)
ACF(mix_mod, resType = "n") %>% 
  plot(alpha = 0.01)
```

In this chunk I will fit linear mixed-effects model with an autoregreessive moving average (ARMA) correlation structure to the data and assesses the autocorrelation structure of the residuals.

```{r - autroregressive moving average }
mod2_ma <- lme(respiration ~ treatment*fdar,
                random = ~1 |rep/plot,
               correlation = corARMA(p = 1, q = 1),
                data = data_w)
mod2_ma
ACF(mod2_ma,resType = "n") %>% 
  plot(alpha = 0.01)
```

```{r - comparison}
anova(mix_mod,mod2_ma)
```

In this chunk, I will fit the linear mixed model to the data, incorporating an exponential correlation structure to account for the correlation between observations based on the different level of days after rain.

```{r - exponential}
mod3_exp <- lme(respiration ~ treatment*fdar,
                random = ~1 |rep/plot,
                correlation = corExp(form = ~dar),
                data = data_w)
mod3_exp
```

```{r}
ACF(mod3_exp, resType = "n") %>%
  plot(alpha = 0.01)
```

```{r - comparison}
anova(mix_mod,mod3_exp)
```

Here, I will fit the linear mixed model to the data, incorporating an Gaussian correlation structure and assessses the autocorrelation structure of the residuals.

```{r - Gaussian}
mod4_gaus <- lme(respiration ~ treatment*fdar,
                random = ~1 |rep/plot,
                correlation = corGaus(form = ~dar),
                data = data_w)
mod4_gaus
```

```{r}
ACF(mod4_gaus, resType = "n") %>%
  plot(alpha = 0.01)
```

```{r - comparison}
anova(mix_mod, mod4_gaus)
```

Here, I will fit the linear mixed model to the data, incorporating an Linear correlation structure and assessses the autocorrelation structure of the residuals.

```{r Linear}
mod5_lin <- lme(respiration ~ treatment*fdar,
                random = ~1 |rep/plot,
                correlation = corLin(form = ~dar),
                data = data_w)

mod5_lin
```


```{r}
ACF(mod5_lin, resType = "n") %>%
  plot(alpha = 0.01)
```

Here, I will fit the linear mixed model to the data, incorporating an Rational Quadratic correlation structure and assessses the autocorrelation structure of the residuals.

```{r - Rational Quadratic }
mod6_rq <- lme(respiration ~ treatment*fdar,
                random = ~1 |rep/plot,
                correlation = corRatio(form = ~dar),
                data = data_w)
mod6_rq
```

```{r}
ACF(mod6_rq, resType = "n") %>%
  plot(alpha = 0.01)
```

Here, I will fit the linear mixed model to the data, incorporating an Spherical correlation structure and assessses the autocorrelation structure of the residuals.

```{r - Spherical}
mod7_sph <- lme(respiration ~ treatment*fdar,
                random = ~1 |rep/plot,
                correlation = corSpher(form = ~dar),
                data = data_w)
mod7_sph
```

```{r}
ACF(mod7_sph, resType = "n") %>%
  plot(alpha = 0.01)
```

Here, we will run a ANOVA based on different model, allowing for the comparison of the models based on their AIC values.

```{r - Final comparison}
anova(mix_mod, mod2_ma, mod3_exp, mod4_gaus, mod5_lin, mod6_rq, mod7_sph) %>%
  as.data.frame() %>%
  rownames_to_column(var = "modelname") %>%
  janitor::clean_names() %>%
  dplyr::select(modelname, model, df, aic, bic) %>%
  arrange(aic)
```


Best model - mod2 ma

Here, we will extract the model residuals and calculate standardized residuals and keep in tidy format. \# checking residuals

```{r}
library(broom.mixed)
mod2_ma_resid <- augment(mod2_ma) %>% 
  mutate(.stdresid = resid(mod2_ma,
                           type = "pearson",
                           scaled = T
                           ))
mod2_ma_resid
```

Here, random effects from the linear mixed model (mod2_ma) will be extracted and visualized using Quantitle-quantile(QQ) plot to assess the normality of the random effect.

```{r - block random effects}
ranef(mod2_ma)[[1]] %>% 
   ggplot(aes(sample=`(Intercept)`))+
  stat_qq(  shape = 21,
            fill = "purple", 
            size = 3,
            alpha = .7
  )+
  stat_qq_line()+
  labs(x = "Theoretical quantile",
       y = "Sample quantile")+
  theme_bw()

```

The points seem a little off, but nothing too worrying. 
# blocks:plots random effects

```{r}
ranef(mod2_ma)[[2]] %>% 
   ggplot(aes(sample=`(Intercept)`))+
  stat_qq(  shape = 21,
            fill = "purple", 
            size = 3,
            alpha = .7
  )+
  stat_qq_line()+
  labs(x = "Theoretical quantile",
       y = "Sample quantile")+
  theme_bw()
```

The tails are a little off, but this is to be expected in limited number of data points. 

# within groups errors
Here we will run a diagnostic plot to assess the goodness-of-fit of the linear mixed effects model, examining the standardized residuals against fitted values to identify potential outliers and assess the trend in the residuals. 

```{r}
ggplot(mod2_ma_resid, aes(x=.fitted, y=.stdresid))+
  geom_hline(yintercept = 0, color="red")+
  geom_point(shape = 21,
             fill = "purple", 
             size = 3,
             alpha = .7)+
  geom_smooth()+
  geom_hline(yintercept = c(-3,3), color = "red")+
  theme_bw()
  
```

Here, we will run QQ plot to visualize whether the standardized residuals follow normal distribution. 

```{r}
ggplot(mod2_ma_resid, aes(sample=.stdresid))+
  stat_qq(  shape = 21,
            fill = "purple", 
            size = 3,
            alpha = .7
  )+
  stat_qq_line()+
  labs(x = "Theoretical quantile",
       y = "Sample quantile")+
  theme_bw()
```

Here, we will run type III ANOVA table for the fixed effects in mod2_ma and observe the significant factor.

```{r}
Anova(mod2_ma, type = 3)
```

Here, we compare means between different treatments within each day of measurement. 

```{r treatment x fdar Interaction}
rm_rcbd_cld_tfdar <- emmeans(mod2_ma, ~ treatment|fdar) %>%
  cld(reversed = T,
      Letters = letters,
      adjust = "none") %>%
  as.data.frame() %>%
  mutate(letter = trimws(.group))
  
  rm_rcbd_cld_tfdar
```

In this chunk, we will see the effects of different treatments on each of the different days. Different letters signify difference. 

```{r}
ggplot(mapping = aes(fill = treatment))+
  geom_boxplot(data = data_w,
               aes(x =treatment, 
                   y = respiration),
               alpha = 0.8) +
  geom_jitter(data = data_w,
              aes(x= treatment,
                  y = respiration),
              shape = 21,
              size = 1,
              alpha = 0.6) +
  geom_label(data = rm_rcbd_cld_tfdar,
             aes(x= treatment,
                 y = emmean,
                 label = letter),
             fill = "white",
             size = 2,
             alpha = 0.9) +
 labs(x = "Land Management",
       y = bquote("Soil respiration ("*mu* "mol" * "m" ^-2 * "s"^-1 *")"))+
  scale_fill_viridis_d() +
  facet_grid(.~fdar) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1))
  
```

Overall, on all days soil efflux values from NPK = disturbance plots were higher than the other treatment plots, especially on day 1 and day 10 after rain, where we see a statistically significant difference between the combined treatment and the other treatments. It is also interesting to note the variability in efflux values in NPK plots. 

In the chunk below, we compare different days after rain within each treatment plots. 

```{r}
rm_rcbd_cld_dartf <- emmeans(mod2_ma, ~ fdar|treatment) %>%
  cld(reversed = T,
      Letters = letters,
      adjust = "none") %>%
  as.data.frame() %>%
  mutate(letter = trimws(.group))
rm_rcbd_cld_dartf

```

In this chunk, we see how soil respiration varies across different levels of the drying cycle("fdar") highlighting significant difference between levels within treatment groups will be visualized using boxplot.

```{r}
ggplot(mapping = aes(fill = fdar))+
  geom_boxplot(data = data_w,
               aes(x =fdar, 
                   y = respiration),
               alpha = 0.8) +
  geom_jitter(data = data_w,
              aes(x= fdar,
                  y = respiration),
              shape = 21,
              size = 1,
              alpha = 0.6) +
  geom_label(data = rm_rcbd_cld_dartf,
             aes(x= fdar,
                 y = emmean,
                 label = letter),
             fill = "white",
             size = 2,
             alpha = 0.9) +
 labs(x = "Days after rain",
       y = bquote("Soil respiration ("*mu* "mol" * "m" ^-2 * "s"^-1 *")"))+
  scale_fill_viridis_d() +
  facet_grid(.~treatment) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
  
```

From the above graph, we can say that soil respiration spikes a day after rain in plots treated with NPK + disturbance. This confirms our hypothesis that soils with combined treatments of NPK + disturbance will have a higher CO2 efflux following a rain event. 

# Team work in GitHub

Whether you are working with your future-self or as duos, make sure to stage, commit, and push after finishing each of the sub-sections above. When committing, write commit messages that are short and descriptive (e.g., finished wrangling).

If you are working in duos, make sure to split the workload. I will check your collaborative work through the commit history, and if one student has contributed significantly more than the other, than that will impact grades.

**Tip 1**: to avoid merge conflicts, make sure to **pull** first, and then start working locally. That will ensure that any changes made by your partner will be "downloaded" before you make changes to the files locally.

**Tip 2**: make use of the Issues on this repository to set up to-do lists and assign tasks to different people. You can also use each issue/task to discuss how things should be run and get to an agreement.

# Submitting your work

Once you have developed all the code and answers, make sure to Render this quarto file.

**Notes on rendering**:

-   Make sure to render your work and inspect how the final html look like.\
-   If it does not look professional for whatever reason, then fix the issue, re-render it, recheck.\
-   Only send me your work once your html file looks professional.\
-   Some potential issues you may encounter and how to fix them:
    -   Some times your code may be creating a table output that is waaay to long and cumbersome to scroll through when rendered. If this is the case, make it more professional looking by using the `head()` function to only print the first handful of rows (instead of thousands of rows).

    -   **DO NOT** delete the file's heading levels (# and ##). They set up the proper heading 1 and 2 levels, and I use them to guide my grading.

    -   If a given chunk is also outputting warnings or messages, inhibit this behavior by changing the chunk options `message` and `warning` to `FALSE`.

    -   If, after rendered, 2 lines of text are connected and you wish to "break line" between them, add 2 extra spaces after the first one.

After rendering, an .html file will be created on your `code` folder.

Rename this file to `LASTNAME1-LASTNAME2_midtermproject.html`.\
For ex., `Bastos-Mendes_midtermproject.html`.

Send the html file to my email (lmbastos\@uga.edu) by **April 11th** 11:59 pm.

# References 

